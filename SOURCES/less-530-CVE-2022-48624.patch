From c8cfca1fd59dae6073f6f768e4fa9197622ae7a7 Mon Sep 17 00:00:00 2001
From: Matt Hink <mhink@ciq.com>
Date: Wed, 20 Nov 2024 20:56:55 -0800
Subject: [PATCH] Rework patch less-530-CVE-48264 for CentOS7

From c6ac6de49698be84d264a0c4c0c40bb870b10144 Mon Sep 17 00:00:00 2001
From: Mark Nudelman <markn@greenwoodsoftware.com>
Date: Sat, 25 Jun 2022 11:54:43 -0700
Subject: [PATCH] Shell-quote filenames when invoking LESSCLOSE.

---
 BUILD/less-458/filename.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/filename.c b/filename.c
index e6727cb..06921bb 100644
--- a/filename.c
+++ b/filename.c
@@ -969,6 +969,8 @@ close_altfile(altfilename, filename, pipefd)
 {
 #if HAVE_POPEN
 	char *lessclose;
+	char *qfilename;
+	char *qaltfilename;
 	FILE *fd;
 	char *cmd;
 	int len;
@@ -993,9 +995,13 @@ close_altfile(altfilename, filename, pipefd)
 		error("Invalid LESSCLOSE variable");
 		return;
 	}
-	len = strlen(lessclose) + strlen(filename) + strlen(altfilename) + 2;
+	qfilename = shell_quote(filename);
+	qaltfilename = shell_quote(altfilename);
+	len = (int) (strlen(lessclose) + strlen(qfilename) + strlen(qaltfilename) + 2);
 	cmd = (char *) ecalloc(len, sizeof(char));
-	SNPRINTF2(cmd, len, lessclose, filename, altfilename);
+	SNPRINTF2(cmd, len, lessclose, qfilename, qaltfilename);
+	free(qaltfilename);
+	free(qfilename);
 	fd = shellcmd(cmd);
 	free(cmd);
 	if (fd != NULL)
-- 
2.43.5

